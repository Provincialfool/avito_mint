<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—Å—ã–ª–∫–∞ ‚Äî –ê–¥–º–∏–Ω–∫–∞ –ß–ê–¢-–ë–û–¢–ê</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .nav-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
        }
        .stats-card {
            background: rgba(33, 37, 41, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-robot me-2"></i> –ê–¥–º–∏–Ω–∫–∞ –ß–ê–¢-–ë–û–¢–ê
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}"><i class="fas fa-tachometer-alt me-1"></i> –î–∞—à–±–æ—Ä–¥</a>
                  <a class="nav-link" href="{{ url_for('participants') }}"><i class="fas fa-users me-1"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</a>
                    <a class="nav-link" href="{{ url_for('broadcast') }}"><i class="fas fa-bullhorn me-1"></i> –†–∞—Å—Å—ã–ª–∫–∞</a>
                       <a class="nav-link" href="{{ url_for('dance_slots') }}"><i class="fas fa-music me-1"></i> –°–ª–æ—Ç—ã</a>
                    <a class="nav-link" href="{{ url_for('text_messages') }}"><i class="fas fa-edit me-1"></i> –¢–µ–∫—Å—Ç—ã</a>
                    <a class="nav-link" href="{{ url_for('config') }}"><i class="fas fa-cogs me-1"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                    <a class="nav-link" href="/admin/logout"><i class="fas fa-sign-out-alt me-1"></i> –í—ã—Ö–æ–¥</a>
            </div>
        </div>
    </nav>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="nav-header">
        <div class="container">
            <h1><i class="fas fa-bullhorn me-2"></i> –†–∞—Å—Å—ã–ª–∫–∞</h1>
            <p class="mb-0">–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</p>
        </div>
    </div>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="broadcast-tab" data-bs-toggle="tab" data-bs-target="#broadcastContent" type="button" role="tab" aria-controls="broadcastContent" aria-selected="true">–†–∞—Å—Å—ã–ª–∫–∞</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback" type="button" role="tab" aria-controls="feedback" aria-selected="false">–§–∏–¥–±–µ–∫</button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="myTabContent">
            <div class="tab-pane fade show active" id="broadcastContent" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card stats-card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-paper-plane me-2"></i>–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('broadcast') }}" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="message" class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (Markdown/Telegram HTML)</label>
                                        <textarea class="form-control" id="message" name="message" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏..." required></textarea>
                                        <div class="form-text">
                                            <strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram-—Ä–∞–∑–º–µ—Ç–∫–∏:</strong>
                                            <code>*–∫—É—Ä—Å–∏–≤*</code>, <code>**–∂–∏—Ä–Ω—ã–π**</code>, <code>`–∫–æ–¥`</code>, <code>[—Å—Å—ã–ª–∫–∞](https://...)</code>.<br>
                                            <span>–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å emoji –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π markdown.</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="specific_user" class="form-label">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                        <select class="form-select" id="specific_user" name="specific_user">
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>
                                        </select>
                                        <div class="form-text">–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ–º—É</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="send_to" class="form-label">–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</label>
                                        <select class="form-select" id="send_to" name="send_to">
                                            <option value="all">–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>
                                            <option value="survey_completed">–ü—Ä–æ—à–µ–¥—à–∏–º –æ–ø—Ä–æ—Å</option>
                                            <option value="no_survey">–ù–µ –ø—Ä–æ—à–µ–¥—à–∏–º –æ–ø—Ä–æ—Å</option>
                                            <option value="dance_registered">–ó–∞–ø–∏—Å–∞–≤—à–∏–º—Å—è –Ω–∞ —Ç–∞–Ω—Ü—ã</option>
                                            <option value="quest_completed">–ó–∞–≤–µ—Ä—à–∏–≤—à–∏–º –∫–≤–µ—Å—Ç</option>
                                            <option value="sticker_generated">–°–æ–∑–¥–∞–≤—à–∏–º —Å—Ç–∏–∫–µ—Ä—ã</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check" id="confirmCheckContainer">
                                            <input class="form-check-input" type="checkbox" id="confirmSend">
                                            <label class="form-check-label text-warning" for="confirmSend">
                                                <i class="fas fa-exclamation-triangle me-1"></i> <span id="confirmText">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="photo" class="form-label">–§–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, jpg/png, –¥–æ 10 –ú–ë)</label>
                                        <input type="file" class="form-control" id="photo" name="photo" accept="image/*">
                                    </div>
                                    <div class="mb-3 row">
                                        <div class="col">
                                            <label for="send_date" class="form-label">–î–∞—Ç–∞</label>
                                            <input type="date" class="form-control" id="send_date" name="send_date">
                                        </div>
                                        <div class="col">
                                            <label for="send_time" class="form-label">–í—Ä–µ–º—è</label>
                                            <input type="time" class="form-control" id="send_time" name="send_time">
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-paper-plane me-1"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="previewMessage()">
                                            <i class="fas fa-eye me-1"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" onclick="clearMessage()">
                                            <i class="fas fa-trash me-1"></i> –û—á–∏—Å—Ç–∏—Ç—å
                                        </button>
                                    </div>
                                </form>

                                <hr class="my-4">

                                <h4><i class="fas fa-clock me-2"></i>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏</h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm table-hover mt-3">
                                        <thead>
                                            <tr>
                                                <th>–¢–µ–∫—Å—Ç</th>
                                                <th>–§–æ—Ç–æ</th>
                                                <th>–í—Ä–µ–º—è</th>
                                                <th>–°—Ç–∞—Ç—É—Å</th>
                                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for msg in scheduled_messages %}
                                            <tr>
                                                <td>{{ msg.text[:100] }}{% if msg.text|length > 100 %}...{% endif %}</td>
                                                <td>
                                                    {% if msg.photo_url %}
                                                        <a href="{{ msg.photo_url }}" target="_blank" class="text-info"><i class="fas fa-image"></i></a>
                                                    {% else %}‚Äî{% endif %}
                                                </td>
                                                <td>{{ msg.scheduled_time.strftime('%d.%m.%Y %H:%M') if msg.scheduled_time else '–°—Ä–∞–∑—É' }}</td>
                                                <td>
                                                    {% if msg.sent %}
                                                        <span class="badge bg-success">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                                                    {% elif msg.is_pending() %}
                                                        <span class="badge bg-warning text-dark">–û–∂–∏–¥–∞–µ—Ç</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if not msg.sent and msg.is_pending() %}
                                                        <a href="{{ url_for('edit_scheduled_message', message_id=msg.id) }}" class="btn btn-sm btn-outline-primary">–ò–∑–º–µ–Ω–∏—Ç—å</a>
                                                        <a href="{{ url_for('delete_scheduled_message', message_id=msg.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?');">–£–¥–∞–ª–∏—Ç—å</a>
                                                    {% else %}‚Äî{% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="col-lg-4">
                        <div class="card stats-card mb-3">
                            <div class="card-header"><i class="fas fa-lightbulb me-2"></i> –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="useTemplate('dance_start')">üíÉ –°—Ç–∞—Ä—Ç —Ç–∞–Ω—Ü–µ–≤</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="useTemplate('quest_reminder')">üß© –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∫–≤–µ—Å—Ç–µ</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="useTemplate('food_announcement')">üçî –û–±–µ–¥ –æ—Ç–∫—Ä—ã—Ç</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="useTemplate('closing_ceremony')">üéâ –ó–∞–∫—Ä—ã—Ç–∏–µ —Ñ–µ—Å—Ç–∏–≤–∞–ª—è</button>
                                    <button class="btn btn-outline-success btn-sm text-start" onclick="useTemplate('mint_motivation')">üåø –ú—è—Ç–∞-–º–æ—Ç–∏–≤–∞—Ü–∏—è</button>
                                    <button class="btn btn-outline-info btn-sm text-start" onclick="useTemplate('work_tips')">üè† –°–æ–≤–µ—Ç—ã —Ä–∞–±–æ—Ç—ã –¥–æ–º–∞</button>
                                    <button class="btn btn-outline-warning btn-sm text-start" onclick="useTemplate('team_intro')">üë• –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–º–∞–Ω–¥–æ–π</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="useTemplate('talents')">üé∏ –¢–∞–ª–∞–Ω—Ç—ã –∫–æ–º–∞–Ω–¥—ã</button>
                                    <button class="btn btn-outline-secondary btn-sm text-start" onclick="useTemplate('emoji_quiz')">üéµ –£–≥–∞–¥–∞–π –ø–µ—Å–Ω—é</button>
                                </div>
                            </div>
                        </div>
                        <div class="card stats-card">
                            <div class="card-header"><i class="fas fa-info-circle me-2"></i> –°–æ–≤–µ—Ç—ã</div>
                            <div class="card-body small">
                                <ul class="list-unstyled mb-0">
                                    <li><i class="fas fa-check text-success me-2"></i> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ emoji –∏ —Ä–∞–∑–º–µ—Ç–∫—É</li>
                                    <li><i class="fas fa-check text-success me-2"></i> –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π—Ç–µ —Ç–µ–∫—Å—Ç</li>
                                    <li><i class="fas fa-check text-success me-2"></i> –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ñ–æ—Ç–æ –∏ —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ —Ñ–∏–¥–±–µ–∫–∞ -->
            <div class="tab-pane fade" id="feedback" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card stats-card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-star me-2"></i>–ó–∞–ø—É—Å–∫ –æ–ø—Ä–æ—Å–∞ —Ñ–∏–¥–±–µ–∫–∞</h5>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('send_feedback_survey') }}">
                                    <div class="mb-3">
                                        <label class="form-label">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–ø—Ä–æ—Å —Ñ–∏–¥–±–µ–∫–∞</label>
                                        <div class="alert alert-info">
                                            <strong>–û–ø—Ä–æ—Å –≤–∫–ª—é—á–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã:</strong><br>
                                            1. –û—Ü–µ–Ω–∫–∞ –∑–æ–Ω—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π Avito Team (1-10)<br>
                                            2. –ó–Ω–∞–Ω–∏—è –æ –∫–æ–º–∞–Ω–¥–µ –ê–≤–∏—Ç–æ<br>
                                            3. –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –≤ –ê–≤–∏—Ç–æ (1-10)<br>
                                            4. –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞ (1-10)
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <select class="form-select" name="send_to">
                                            <option value="all">–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>
                                            <option value="survey_completed">–ü—Ä–æ—à–µ–¥—à–∏–º –æ–ø—Ä–æ—Å</option>
                                            <option value="dance_registered">–ó–∞–ø–∏—Å–∞–≤—à–∏–º—Å—è –Ω–∞ —Ç–∞–Ω—Ü—ã</option>
                                            <option value="quest_completed">–ó–∞–≤–µ—Ä—à–∏–≤—à–∏–º –∫–≤–µ—Å—Ç</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="confirmFeedback" required>
                                        <label class="form-check-label text-warning" for="confirmFeedback">
                                            <i class="fas fa-exclamation-triangle me-1"></i> –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –∑–∞–ø—É—Å–∫ –æ–ø—Ä–æ—Å–∞ —Ñ–∏–¥–±–µ–∫–∞
                                        </label>
                                    </div>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-star me-1"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ä–æ—Å —Ñ–∏–¥–±–µ–∫–∞
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card stats-card">
                            <div class="card-header"><i class="fas fa-chart-bar me-2"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∏–¥–±–µ–∫–∞</div>
                            <div class="card-body">
                                <p><strong>–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤:</strong> {{ feedback_stats.total if feedback_stats else 0 }}</p>
                                <p><strong>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π:</strong> {{ feedback_stats.avg_activity if feedback_stats else 'N/A' }}</p>
                                <p><strong>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong> {{ feedback_stats.avg_recommend if feedback_stats else 'N/A' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-eye me-2"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <strong>–ß–ê–¢-–ë–û–¢</strong> <span class="ms-auto small">üì¢ –†–∞—Å—Å—ã–ª–∫–∞</span>
                        </div>
                        <div class="card-body">
                            <div id="previewContent" class="border-start border-primary border-3 ps-3"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                const select = document.getElementById('specific_user');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>';
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.telegram_id;
                    option.textContent = `${user.first_name} ${user.last_name || ''} ${user.username ? `(@${user.username})` : ''}`.trim();
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function updateConfirmText() {
            const specificUser = document.getElementById('specific_user').value;
            const sendTo = document.getElementById('send_to').value;
            const confirmText = document.getElementById('confirmText');
            const confirmCheck = document.getElementById('confirmSend');
            const confirmContainer = document.getElementById('confirmCheckContainer');
            
            if (specificUser) {
                const userOption = document.querySelector(`#specific_user option[value="${specificUser}"]`);
                const userName = userOption ? userOption.textContent : '–≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é';
                confirmText.textContent = `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É ${userName}`;
                confirmContainer.style.display = 'block';
                confirmCheck.required = true;
            } else {
                const categoryText = {
                    'all': '–≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º',
                    'survey_completed': '–ø—Ä–æ—à–µ–¥—à–∏–º –æ–ø—Ä–æ—Å',
                    'no_survey': '–Ω–µ –ø—Ä–æ—à–µ–¥—à–∏–º –æ–ø—Ä–æ—Å',
                    'dance_registered': '–∑–∞–ø–∏—Å–∞–≤—à–∏–º—Å—è –Ω–∞ —Ç–∞–Ω—Ü—ã',
                    'quest_completed': '–∑–∞–≤–µ—Ä—à–∏–≤—à–∏–º –∫–≤–µ—Å—Ç',
                    'sticker_generated': '—Å–æ–∑–¥–∞–≤—à–∏–º —Å—Ç–∏–∫–µ—Ä—ã'
                };
                confirmText.textContent = `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É ${categoryText[sendTo] || '–≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º'}`;
                confirmContainer.style.display = 'block';
                confirmCheck.required = true;
            }
        }

        // Telegram Markdown/HTML mini-parser
        function telegramParse(text) {
            return text
                .replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/\*\*(.+?)\*\*/g, '<b>$1</b>')
                .replace(/\*(.+?)\*/g, '<i>$1</i>')
                .replace(/`(.+?)`/g, '<code>$1</code>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                .replace(/\n/g, '<br>');
        }

        function useTemplate(key) {
            const templates = {
                'dance_start': 'üíÉ –¢–∞–Ω—Ü—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è! –ü–æ–¥—Ö–æ–¥–∏—Ç–µ –∫ —Å—Ü–µ–Ω–µ ‚Äî –±—É–¥–µ—Ç –∂–∞—Ä–∫–æ! üî•',
                'quest_reminder': 'üß© –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ–π—Ç–∏ –∫–≤–µ—Å—Ç! –ù–∞—á–∞–ª–æ ‚Äî –∑–æ–Ω–∞ "–ú–∞—è–∫", –ø—Ä–∏–∑—ã –∂–¥—É—Ç!',
                'food_announcement': 'üçî –§—É–¥-–∫–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç! –ó–∞ –µ–¥—É –∏ –Ω–∞–ø–∏—Ç–∫–∞–º–∏ ‚Äî —Å—é–¥–∞.',
                'closing_ceremony': 'üéâ –í 18:00 ‚Äî —Ü–µ—Ä–µ–º–æ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –±—ã–ª–∏ —Å –Ω–∞–º–∏!',
                'mint_motivation': 'üåø **–ú—è—Ç–∞-–º–æ—Ç–∏–≤–∞—Ü–∏—è**\n\n–°–µ–≥–æ–¥–Ω—è —Ç–≤–æ–π –¥–µ–Ω—å! ‚òÄÔ∏è –ö–∞–∫ –Ω–∞ –î–∏–∫–æ–π –ú—è—Ç–µ ‚Äî –æ—Ç–ø—É—Å—Ç–∏ –≤—Å–µ –∑–∞–±–æ—Ç—ã –∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Å—è –º–æ–º–µ–Ω—Ç–æ–º! üé∂',
                'work_tips': 'üè† **–°–æ–≤–µ—Ç—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∏–∑ –¥–æ–º–∞:**\n\n–†–∞–±–æ—Ç–∞–µ—à—å –∏–∑ –¥–æ–º–∞? üè† –°–æ–∑–¥–∞–π —É—é—Ç–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –∏ –Ω–µ –∑–∞–±—É–¥—å –ø—Ä–æ –ø–µ—Ä–µ—Ä—ã–≤—ã! üßò‚Äç‚ôÄÔ∏è (–ß—Ç–æ–±—ã –ø–æ—Ç–æ–º —Å –Ω–æ–≤—ã–º–∏ —Å–∏–ª–∞–º–∏ –ø–æ–∫–æ—Ä—è—Ç—å –î–∏–∫—É—é –ú—è—Ç—É üòâ)',
                'team_intro': 'üë• **–ó–Ω–∞–∫–æ–º–∏–º —Å –∫–æ–º–∞–Ω–¥–æ–π –ê–≤–∏—Ç–æ:**\n\n–•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å, –∫—Ç–æ —Ç–≤–æ–π —Å–æ—Å–µ–¥ –ø–æ –æ—Ñ–∏—Å—É? ü§î –°–µ–≥–æ–¥–Ω—è –∑–Ω–∞–∫–æ–º–∏–º—Å—è —Å [–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ê–≤–∏—Ç–æ]! ü§© –ò —É –Ω–µ–≥–æ –µ—Å—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –ª—É—á—à–µ–≥–æ —á–∞—è –≤ –º–∏—Ä–µ!\n\n**–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:**\n‚Ä¢ –≤–æ–¥–∞ ‚Äî 800 –º–ª\n‚Ä¢ —á–µ—Ä–Ω—ã–π —á–∞–π ‚Äî 4 —á. –ª.\n‚Ä¢ –ø–µ—Ä—Å–∏–∫–∏ ‚Äî 3 —à—Ç.\n‚Ä¢ —Å–∞—Ö–∞—Ä ‚Äî 1 —Å—Ç. –ª.\n‚Ä¢ –ª–∏–º–æ–Ω—ã ‚Äî 0,5 —à—Ç.\n‚Ä¢ –ª—ë–¥ ‚Äî 10 –∫—É–±–∏–∫–æ–≤\n‚Ä¢ –º—è—Ç–∞ ‚Äî 1 –≤–µ—Ç–æ—á–∫–∞\n\n**–°–ø–æ—Å–æ–± –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:**\n1. –í—Å–∫–∏–ø—è—Ç–∏—Ç–µ –≤–æ–¥—É –∏ –∑–∞–ª–µ–π—Ç–µ –µ–π –∑–∞–≤–∞—Ä–∫—É, –æ—Å—Ç–∞–≤—å—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç. –ü—Ä–æ—Ü–µ–¥–∏—Ç–µ.\n2. –í –Ω–∞–ø–∏—Ç–æ–∫ –¥–æ–±–∞–≤—å—Ç–µ —Å–∞—Ö–∞—Ä, –ø–µ—Ä–µ–º–µ—à–∞–π—Ç–µ. –î–æ–±–∞–≤—å—Ç–µ –Ω–∞—Ä–µ–∑–∞–Ω–Ω—ã–π –ª–∏–º–æ–Ω –∏ –æ—Å—Ç–∞–≤—å—Ç–µ –æ—Å—Ç—ã–≤–∞—Ç—å.\n3. –û—á–∏—Å—Ç–∏—Ç–µ –¥–≤–∞ –ø–µ—Ä—Å–∏–∫–∞, —É–¥–∞–ª–∏—Ç–µ –∫–æ—Å—Ç–æ—á–∫–∏ –∏ –ø—é—Ä–∏—Ä—É–π—Ç–µ –≤ –±–ª–µ–Ω–¥–µ—Ä–µ. –î–≤–∞ –¥—Ä—É–≥–∏—Ö –ø–µ—Ä—Å–∏–∫–∞ –Ω–∞—Ä–µ–∂—å—Ç–µ –¥–æ–ª—å–∫–∞–º–∏.\n4. –í –æ—Ö–ª–∞–∂–¥—ë–Ω–Ω—ã–π —á–∞–π –¥–æ–±–∞–≤—å—Ç–µ –ø—é—Ä–µ –ø–µ—Ä—Å–∏–∫–∞, –ø–µ—Ä–µ–º–µ—à–∞–π—Ç–µ. –ó–∞—Ç–µ–º ‚Äî –Ω–∞—Ä–µ–∑–∞–Ω–Ω—ã–µ –ø–ª–æ–¥—ã, –º—è—Ç—É –∏ –∫—É–±–∏–∫–∏ –ª—å–¥–∞. –ü–æ–¥–∞–≤–∞–π—Ç–µ, —Ä–∞–∑–ª–∏–≤ –ø–æ –±–æ–∫–∞–ª–∞–º!',
                'talents': 'üé∏ **–¢–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–µ –õ—é–¥–∏ Avito Team:**\n\n–í –ê–≤–∏—Ç–æ Team –Ω–µ —Ç–æ–ª—å–∫–æ –∫—Ä—É—Ç—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã, –Ω–æ –∏ —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–µ –º—É–∑—ã–∫–∞–Ω—Ç—ã! üé∏ –ü–æ—Å–ª—É—à–∞–π –ø–µ—Å–Ω—é –æ—Ç [–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞]! üé∂\n\n*–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ–∫—Ä—É–∂–æ–∫, –≥–¥–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∏–≥—Ä–∞–µ—Ç –Ω–∞ –º—É–∑—ã–∫–∞–ª—å–Ω–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ / –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–∏ —Ç–∞–ª–∞–Ω—Ç—ã.*',
                'emoji_quiz': 'üéµ **–£–≥–∞–¥–∞–π –ø–µ—Å–Ω—é –ø–æ —Å–º–∞–π–ª–∏–∫–∞–º:**\n\nüéµ + üé∏ + üèïÔ∏è = ?\n\n–£–≥–∞–¥–∞–π –ø–µ—Å–Ω—é, –∫–æ—Ç–æ—Ä—É—é —á–∞—â–µ –≤—Å–µ–≥–æ –ø–æ—é—Ç –Ω–∞ –î–∏–∫–æ–π –ú—è—Ç–µ! üé§ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Å—Ç–µ! üòâ'
            };
            const el = document.getElementById('message');
            el.value = templates[key];
            el.focus();
        }

        function previewMessage() {
            const msg = document.getElementById('message').value;
            if (!msg.trim()) return alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
            document.getElementById('previewContent').innerHTML = telegramParse(msg);
            new bootstrap.Modal(document.getElementById('previewModal')).show();
        }

        function clearMessage() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                document.getElementById('message').value = '';
                document.getElementById('confirmSend').checked = false;
                document.getElementById('photo').value = '';
                document.getElementById('specific_user').value = '';
                document.getElementById('send_to').value = 'all';
                updateConfirmText();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            updateConfirmText();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            document.getElementById('specific_user').addEventListener('change', updateConfirmText);
            document.getElementById('send_to').addEventListener('change', updateConfirmText);
        });
    </script>
</body>
</html>